#!/bin/bash

# Script р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕Бр╣Йр╣Др╕Вр╕Ыр╕▒р╕Нр╕лр╕▓ 502 Bad Gateway
echo "ЁЯФз р╣Бр╕Бр╣Йр╣Др╕Вр╕Ыр╕▒р╕Нр╕лр╕▓ 502 Bad Gateway"
echo "=============================="

# 1. р╕лр╕вр╕╕р╕Ф services р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
echo "тП╣я╕П  р╕лр╕вр╕╕р╕Ф services р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф..."
docker-compose down

# 2. р╕ер╕Ъ containers р╣Бр╕ер╕░ images р╣Ар╕Бр╣Ир╕▓
echo "ЁЯЧСя╕П  р╕ер╕Ъ containers р╣Бр╕ер╕░ images р╣Ар╕Бр╣Ир╕▓..."
docker system prune -f
docker image prune -f

# 3. Build р╣Гр╕лр╕бр╣И
echo "ЁЯФи Build Docker image р╣Гр╕лр╕бр╣И..."
docker build -t bamboo-platform .

# 4. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ build р╕кр╕│р╣Ар╕гр╣Зр╕И
if [ $? -eq 0 ]; then
    echo "тЬЕ Build р╕кр╕│р╣Ар╕гр╣Зр╕И"
else
    echo "тЭМ Build р╕ер╣Йр╕бр╣Ар╕лр╕ер╕з"
    exit 1
fi

# 5. Start services р╣Гр╕лр╕бр╣И
echo "ЁЯЪА р╣Ар╕гр╕┤р╣Ир╕б services р╣Гр╕лр╕бр╣И..."
docker-compose up -d

# 6. р╕гр╕нр╣Гр╕лр╣Й services р╣Ар╕гр╕┤р╣Ир╕бр╕Чр╕│р╕Зр╕▓р╕Щ
echo "тП│ р╕гр╕нр╣Гр╕лр╣Й services р╣Ар╕гр╕┤р╣Ир╕бр╕Чр╕│р╕Зр╕▓р╕Щ..."
sleep 10

# 7. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕Цр╕▓р╕Щр╕░
echo "ЁЯФН р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕Цр╕▓р╕Щр╕░ services:"
docker-compose ps

# 8. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ logs
echo "ЁЯУЛ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ logs р╕ер╣Ир╕▓р╕кр╕╕р╕Ф:"
docker-compose logs --tail=20 bamboo-platform

# 9. р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕З
echo "ЁЯМР р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕З localhost:"
curl -I http://localhost/healthz || echo "тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╣Др╕Фр╣Й"

echo ""
echo "тЬЕ р╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕Вр╣Ар╕кр╕гр╣Зр╕Ир╕кр╕┤р╣Йр╕Щ"
echo "ЁЯМР р╕ер╕нр╕Зр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕З: http://43.208.154.243"
echo "ЁЯУЭ р╕лр╕▓р╕Бр╕вр╕▒р╕Зр╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓ р╣Гр╕лр╣Йр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ logs р╕Фр╣Йр╕▓р╕Щр╕Ър╕Щ"
